가능해요. 다만 **Playwright는 “이미 떠있는 일반 크롬/엣지 창”에 그냥 붙을 수는 없고**, 그 브라우저를 **원격 디버깅(CDP) 모드로 띄운 상태**여야 “붙어서” 조작할 수 있습니다.

아래 2가지 중에서 선택하면 됩니다.

---

## 방법 A (사용자가 원하는 방식): “이미 떠있는 브라우저에 붙어서” 실행 (CDP Attach)

### 1) 크롬(또는 엣지)을 Remote Debugging 모드로 실행

> **중요:** 기존에 그냥 띄워둔 크롬에는 붙을 수 없어서, **이 플래그로 띄운 브라우저**에서 POP을 열어두셔야 합니다.

### Windows (Chrome)

```bat
"C:\Program Files\Google\Chrome\Application\chrome.exe" ^
  --remote-debugging-port=9222 ^
  --user-data-dir="%TEMP%\chrome-pop-profile"
```

### Windows (Edge)

```bat
"C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe" ^
  --remote-debugging-port=9222 ^
  --user-data-dir="%TEMP%\edge-pop-profile"
```

### Linux

```bash
google-chrome --remote-debugging-port=9222 --user-data-dir=/tmp/chrome-pop-profile
```

이렇게 뜬 브라우저에서 **삼성 POP 로그인 → 종합차트 화면까지 띄워 둔 상태**로 두세요.

---

### 2) 기존 `pop_capture.py`에 “CDP 접속” 옵션을 추가해서 실행

아래처럼 **pop_capture.py에 최소 변경**만 하면 됩니다.

#### (1) argparse에 옵션 2개 추가

```python
ap.add_argument("--cdp", default=None, help="CDP endpoint, e.g. http://127.0.0.1:9222")
ap.add_argument("--page-url-contains", default="samsungpop", help="Pick an existing tab whose URL contains this.")
```

#### (2) `main()`에서 브라우저/페이지 생성 부분을 아래로 교체

기존 `browser = p.chromium.launch(...) ~ context.new_page()` 블록을 아래로 바꾸세요:

```python
with sync_playwright() as p:
    if args.cdp:
        # 1) 이미 떠있는(디버그 모드) 크롬에 "붙기"
        browser = p.chromium.connect_over_cdp(args.cdp)

        # 2) 기존 컨텍스트/탭 중에서 POP 탭 찾기
        if not browser.contexts:
            raise RuntimeError("No contexts found on the CDP browser. Is Chrome started with --remote-debugging-port?")
        context = browser.contexts[0]

        page = None
        for pg in context.pages:
            if args.page_url_contains in (pg.url or ""):
                page = pg
                break

        # 못 찾으면 첫 탭 사용 (또는 새 탭 열기)
        if page is None:
            page = context.pages[0] if context.pages else context.new_page()
            if args.url:
                page.goto(args.url, wait_until="domcontentloaded")

        # 주의: CDP로 붙은 경우, context.close() 하면 사용자가 띄운 브라우저에 영향 갈 수 있으니 닫지 않음.
    else:
        # 기존 방식(Playwright가 새 브라우저 실행)
        browser = p.chromium.launch(headless=bool(args.headless))
        context = browser.new_context(viewport={"width": 1366, "height": 768}, locale="ko-KR")
        page = context.new_page()
        page.set_default_timeout(args.timeout_ms)
        page.goto(args.url, wait_until="domcontentloaded")
```

#### (3) 종료 처리 주의 (CDP 모드에서는 context.close() 호출하지 않기)

파일 맨 아래 종료 부분에서:

* CDP 모드일 때는 `context.close()`는 생략
* `browser.close()`는 “연결 해제” 용도로만 쓰는 게 안전합니다.

예:

```python
if not args.cdp:
    context.close()
browser.close()
```

---

### 3) 실행 명령

브라우저(디버그 모드)로 POP 화면이 떠있는 상태에서:

```bash
python pop_capture.py \
  --cdp "http://127.0.0.1:9222" \
  --page-url-contains "samsungpop" \
  --code 015760 \
  --out "./shots" \
  --headless 0
```

* `--page-url-contains`는 “어떤 탭을 잡을지” 기준입니다. POP 탭 URL에 맞게 바꾸면 더 안정적입니다.

---

## 방법 B (대안, 더 단단함): “로그인 1회만” 하고 이후는 자동 (Persistent Profile)

“이미 떠있는 브라우저에 붙기”가 아니라, Playwright가 **항상 같은 프로필 폴더**로 브라우저를 띄워서 쿠키/세션을 유지합니다.

* 처음 1번만 로그인
* 이후 실행은 자동

원하시면 이 방식으로도 `launch_persistent_context()` 기반 템플릿을 바로 드릴게요.

---

## 마지막 체크 (현실적인 함정 1개)

만약 POP의 종목코드 입력칸이 **DOM `<input>`이 아니라 캔버스 기반 가짜 입력**이면, CDP로 붙어도 selector가 안 잡힙니다.
그 경우엔 제가 이전 코드에 넣어둔 **`--canvas-fallback` + 좌표 클릭**이 필요합니다.

---

원하시는 방식이 **A(CDP attach)**가 맞다면, 지금 환경이 **Chrome인지 Edge인지**, 그리고 POP 탭 URL에 `samsungpop`가 실제로 포함되는지 정도만 확인해서 `--page-url-contains` 값을 최적화해드릴 수 있어요. (질문 없이도, 현재 값으로 일단 동작하게 설계는 되어 있습니다.)
